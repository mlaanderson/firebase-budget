<% 
if (items.length > 0) {
    var cat = items[0].category;
    var style = 0;
    for (var n = 0; n < items.length; n++ ) { 
        if (cat != items[n].category) {
            style = (style + 1) % 2;
            cat = items[n].category;
        }
%>
<tr class="row_<%= style %>" id="<%= items[n].__key__ %>">
    <td class="trDate"><%= new Date(items[n].date).format('MMM d, yyyy') %></td>
    <td class="trCategory"><%= items[n].category %></td>
    <td class="trName">
        <%= items[n].name %>
        <% if (items[n].cash == true) { %><span title="Cash">$</span><%}%>
        <% if (items[n].checkLink) { %><span title="Check">&#x2328;</span><%}%>
        <% if (items[n].recurring) { %><span id="<%= items[n].__key__ %>_recurring" recurring="<%= items[n].recurring %>" title="Recurring">&#x21bb;</span><%}%>
        <% if (items[n].paid) { %><span title="Paid">&#x2713;</span><%}%>
    </td>
    <td class="trAmount" style="text-align: right"><%= items[n].amount.toCurrency() %></td>
    <td class="trTotal" style="text-align: right"><%= items[n].total.toCurrency() %></td>
</tr>
<% 
    }
}
%>

<script>
    var nameHoverTimeout, namePopup;
    
    function handleUpdate(snapshot) {
        var id = snapshot.key;
        var val = snapshot.val();

        if ($('#' + id).length > 0) {
            $('#' + id + ' td.trDate').text(new Date(val.date).format('MMM d, yyyy'));
            $('#' + id + ' td.trCategory').text(val.category);
            $('#' + id + ' td.trName').empty().append(
                val.name + " " + 
                (val.cash ? "<span title='Cash'>$</span>" : "") + 
                (val.checkLink ? "<span title='Check'>\u2328</span>": "") +
                (val.recurring ? "<span title='Recurring'>\u21bb</span>" : "") +
                (val.paid ? "<span title='Paid'>\u2713</span>" : "")
            );
            $('#' + id + ' td.trAmount').text(val.amount.toCurrency());
            $('#' + id + ' td.trTotal').text(val.total.toCurrency());
        }
    }
    
    $('#main tr').on('mouseout', function() { 
        $('tr').css('background-color', ''); 
    });
    $('#main td').on('mouseover', function(e) {
        e.target = $(e.target);
        
        $('tr').css('background-color', '');
        
        while (e.target.parent() && (e.target.is('tr') == false)) {
            e.target = e.target.parent();
        }
        
        if (e.target.is('tr')) {
            e.target.css('background-color', '#eef');
        }
    });
    $('tr').on('dblclick', function(e) {
        e.preventDefault();
        
        editTransaction(e.currentTarget.id);
    });
    
    $('#main tr').on('taphold', function(e) {
        e.preventDefault();
        editTransaction(e.currentTarget.id);
    });
    
    $('#main tr').on('click', function(e) {
        e.preventDefault();
        e.target = $(e.target);
        
        if (e.target.is('tr')) {
            e.target.css('background-color', '#eef');
        }
        
        previewTransaction(e.currentTarget.id);
    });
    
    $('#main tr').disableSelection();
    
    $('.trName').on('mouseover', function(e) {
        nameHoverTimeout = setTimeout(function() {
            var id = $(e.currentTarget).parent()[0].id;
            m_primaryAccount.child('transactions/' + id).once('value', function(snapshot) {
                var name = snapshot.val().name;
                var category = snapshot.val().category;
                m_primaryAccount.child('transactions').orderByChild('name').startAt(name).endAt(name).once('value', function(snap) {
                    var trs = snap.val();
                    var sum = 0;
                    for (k in trs) {
                        if (category == trs[k].category) {
                            sum += trs[k].amount;
                        }
                    }
                    $(e.currentTarget).prop('title', Math.abs(sum).toCurrency());
                });
            });
        }, 100);
    });
    $('.trName').on('mouseout', function() { 
        clearTimeout(nameHoverTimeout); 
    });
    
    //$('[recurring]').on('click', function(e) {
    //    editRecurring(e.target.getAttribute('recurring'));
    //});
</script>